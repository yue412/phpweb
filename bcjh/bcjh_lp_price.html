<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>
        爆炒江湖
    </title>
    <style type="text/css">
        div.no {
            font-size: 120%;
            display: inline
        }

        div.yes {
            font-size: 80%;
            display: inline
        }

        div.content {
            color: #FF0000;
            display: inline
        }

        div.level {
            display: inline
        }
    </style>
    <script type="text/javascript" src="../common.js">
    </script>
    <script type="text/javascript" src="bcjh_data.js">
    </script>
    <script type="text/javascript" src="bcjh_common.js">
    </script>
    <script type="text/javascript" src="bcjh_skill.js">
    </script>
    <script type="text/javascript" src="LP.js">
    </script>
    <script type="text/javascript" src="TableSorterV3.js">
    </script>    
    <script type="text/javascript">
        function get_recipe_by_id(recipes, id)
        {
            for (let i = 0; i < recipes.length; i++) {
                const recipe = recipes[i];
                if(recipe.recipeId == id)
                    return recipe;
            }
            return null;
        }
        function sort_result(a,b)
        {
            if (a[0] < (b[0] - g_epsilon))
                return 1;
            else if (a[0] > (b[0] + g_epsilon))
                return -1;
            else
                return 0;
        }
        function sort_result2(a,b)
        {
            var t1 = a[1]*a[2].limit;
            var t2 = b[1]*b[2].limit;
            if (t1 < (t2 - g_epsilon))
                return 1;
            else if (t1 > (t2 + g_epsilon))
                return -1;
            else
                return 0;
        }
        /*
        function display_price()
        {
            do_ajax("get_db_data.php?name=bcjh_recipes&order_field=id", function(text){
                var my_recipes = JSON.parse(text);
                do_ajax("get_db_data.php?name=bcjh_chefs&order_field=id", function(text){
                    init_skills(g_bcjh_data.skills);
                    my_chefs = JSON.parse(text);
                    init_chefs(my_chefs);

                    var new_recipes = build_recipes(g_bcjh_data.recipes, my_recipes, my_chefs);

                    var e2 = document.getElementById("time_limit");
                    var time_limit = e2.value*3600;
                    var comb_list = combination(my_chefs.length, 3);
                    var final_objective_value = -1;
                    var final_result = [];
                    var dateBegin = new Date();
                    for (let i = 0; i < comb_list.length; i++) {

                        const comb = comb_list[i];

                        var result = [];
                        for (let k = 0; k < new_recipes.length; k++) {
                            const recipe = new_recipes[k];
                            for (let j = 0; j < comb.length; j++) {
                                const index = comb[j];
                                var chef = my_chefs[index];
                                var price = calc_price(recipe, chef, my_chefs, 0);
                                if(price > 0)
                                {
                                    result.push([price/recipe.time, price, recipe, chef]);
                                }
                            }
                        }
                        if(time_limit==0)
                            result.sort(sort_result2);
                        else
                            result.sort(sort_result);
                        var result2 = [];
                        var total_value = 0;
                        var map = new Map();
                        var recipe_map = new Map();
                        if(time_limit == 0)
                        {
                            for (let j = 0; j < result.length; j++) {
                                const r = result[j];
                                if (recipe_map.has(r[2].name)) 
                                    continue;
                                if (map.has(r[3].name))
                                {
                                    if(map.get(r[3].name) >= 3)
                                        continue;
                                }
                                else
                                {
                                    map.set(r[3].name, 0);
                                }
                                map.set(r[3].name, map.get(r[3].name)+1);
                                result2.push([r[1], r[2].limit, r[2], r[3]]);
                                total_value += r[1]*r[2].limit;
                                recipe_map.set(r[2].name, 1);
                                if(result2.length >= 9)
                                    break;
                            }
                        }
                        else 
                        {
                            var left_time = time_limit;
                            for (let j = 0; j < result.length; j++) {
                                const r = result[j];
                                if (recipe_map.has(r[2].name)) 
                                    continue;
                                if (map.has(r[3].name))
                                {
                                    if(map.get(r[3].name) >= 3)
                                        continue;
                                }
                                else
                                {
                                    map.set(r[3].name, 0);
                                }
                                map.set(r[3].name, map.get(r[3].name)+1);
                                var cnt = Math.min(Math.floor(left_time / r[2].time), r[2].limit);
                                if(cnt == 0)
                                    continue;
                                result2.push([r[1], cnt, r[2], r[3]]);
                                left_time -= cnt*r[2].time;
                                total_value += r[1]*cnt;
                                recipe_map.set(r[2].name, 1);
                                if(result2.length >= 9 || left_time <= 0)
                                    break;
                            }
                        }
                        if(total_value > final_objective_value)
                        {
                            final_objective_value = total_value;
                            final_result = result2;
                        }                        
                    }
                    var dateEnd = new Date();
                    var dateDiff = dateEnd.getTime() - dateBegin.getTime();
                    var e = document.getElementById("time");
                    e.innerHTML = "time(ms):" + dateDiff;
                    //var r = solve(objective_function, constraint_list, result, objective_value);
                    var e = document.getElementById("price");
                    //var s = "复杂度:"+ g_debug_simplex_cnt + "<br>" + final_objective_value.value + "<br>";// + JSON.stringify(result) + "<br>";
                    var s = "<table id=\"tb2\" border=\"1\">";
                        s += "<tr>";
                        s += "<td>";
                        s += "名称";
                        s += "</td>";
                        s += "<td>";
                        s += "菜谱";
                        s += "</td>";
                        s += "<td>";
                        s += "解";
                        s += "</td>";
                        s += "<td>";
                        s += "单价";
                        s += "</td>";
                        s += "<td>";
                        s += "数量";
                        s += "</td>";
                        s += "<td>";
                        s += "总价";
                        s += "</td>";
                        s += "<td>";
                        s += "时间(秒)";
                        s += "</td>";
                        s += "<td>";
                        s += "时间";
                        s += "</td>";
                        s += "</tr>";
                    var total_time = 0;
                    for (let i = 0; i < final_result.length; i++) {
                        const r = final_result[i];
                        var recipe = r[2];
                        var chef = r[3];
                        var price = r[0];
                        var cnt = r[1];
                        total_time += recipe.time*cnt;
                        s += "<tr>";
                        s += "<td>";
                        s += chef.name;
                        s += "</td>";
                        s += "<td>";
                        s += recipe.name;
                        s += "</td>";
                        s += "<td>";
                        s += 1;
                        s += "</td>";
                        s += "<td>";
                        s += price;
                        s += "</td>";
                        s += "<td>";
                        s += cnt;
                        s += "</td>";
                        s += "<td>";
                        s += price * cnt;
                        s += "</td>";
                        s += "<td>";
                        s += recipe.time * cnt;
                        s += "</td>";
                        s += "<td>";
                        s += display_time(recipe.time * cnt);
                        s += "</td>";
                        s += "</tr>";
                    }
                    s += "</table>";
                    s += "合计:" + final_objective_value + " - " + display_time(total_time);// + JSON.stringify(result) + "<br>";
                    e.innerHTML =  s;
                    var x = new TableSorter("tb2");
                });
            });
        }
        */

        function filter_recipes(recipes, chefs, comb)
        {
            var chef_recipe = [];
            for (let i = 0; i < comb.length; i++) {
                chef_recipe.push(new Array());
            }
            for (let k = 0; k < recipes.length; k++) {
                const recipe = recipes[k];
                for (let j = 0; j < comb.length; j++) {
                    const index = comb[j];
                    var chef = chefs[index];
                    var price = calc_price(recipe, chef, chefs, 0);
                    if(price > 0)
                    {
                        chef_recipe[j].push([price/recipe.time, recipe]);
                    }
                }
            }
            var set = new Set();
            for (let i = 0; i < chef_recipe.length; i++) {
                var arr = chef_recipe[i];
                arr.sort(function(a,b){
                    if (a[0] < (b[0] + g_epsilon))
                        return 1;
                    else if (a[0] > (b[0] - g_epsilon))
                        return -1;
                    else
                        return 0;
                })
                for (let j = 0; j < arr.length && j < 9; j++) {
                    const obj = arr[j];
                    set.add(obj[1]);
                }
            }
            return Array.from(set);
        }

        function filter_chef(chefs)
        {
            var arr = [];
            for (let i = 0; i < chefs.length; i++) {
                const chef = chefs[i];
                var name = "ck_chef_"+chef.id;
                var e = document.getElementById(name);
                if (e && e.checked) {
                    arr.push(chef);
                }
            }
            return arr;
        }

        function build_constraint(objective_function, constraint_list, new_recipes, my_chefs, comb, time_limit)
        {
            objective_function.is_max = true;
            objective_function.items = [];                        
            //var my_recipes_price = [];

            var constraint_time = new Object(); // 时间限制
            constraint_time.opr_type = -1;
            constraint_time.value = time_limit;
            constraint_time.items = [];


            var constraint_arr = new Array(comb.length);
            for (let j = 0; j < constraint_arr.length; j++) {
                constraint_arr[j] = new Object(); // 一个人只能做3个菜
                constraint_arr[j].opr_type = -1;
                constraint_arr[j].value = 3;
                constraint_arr[j].items = [];
            }
            // material
            var material_constraint_map = new Map();
            for (let j = 0; j < g_bcjh_data.materials.length; j++) {
                const m = g_bcjh_data.materials[j];
                var e = document.getElementById("material_cnt_"+m.materialId);
                if (e.value != "")
                {
                    var constraint_material = new Object(); // 时间限制
                    constraint_material.opr_type = -1;
                    constraint_material.value = parseInt(e.value);
                    constraint_material.items = [];                    
                    material_constraint_map.set(m.materialId, constraint_material);
                }
            }
            var e2 = document.getElementById("price_add");
            var new_recipes2 = filter_recipes(new_recipes, my_chefs, comb);
            for (let k = 0; k < new_recipes2.length; k++) {
                const recipe = new_recipes2[k];
                var constraint = new Object(); // 同一个菜只能一个人做
                constraint.opr_type = -1;
                constraint.value = 1;
                constraint.items = [];
                for (let j = 0; j < comb.length; j++) {
                    const index = comb[j];
                    var chef = my_chefs[index];
                    var price = calc_price(recipe, chef, my_chefs, e2.value);
                    if(price > 0)
                    {
                        var var_name = "X_"+recipe.recipeId+"_"+index;
                        objective_function.items.push([price*recipe.limit, var_name]);
                        constraint_time.items.push([recipe.total_time(), var_name]);
                        constraint.items.push([1, var_name]);
                        constraint_arr[j].items.push([1, var_name]);
                        for (let n = 0; n < recipe.materials.length; n++) {
                            const m = recipe.materials[n];
                            if(material_constraint_map.has(m.material))
                            {
                                material_constraint_map.get(m.material).items.push([m.quantity*recipe.limit, var_name]);
                            }
                        }
                        
                    }
                }
                if(constraint.items.length > 0)
                    constraint_list.push(constraint);
            }
            for (let j = 0; j < constraint_arr.length; j++) {
                if (constraint_arr[j].items.length > 0)
                    constraint_list.push(constraint_arr[j]);
            }
            if(time_limit> g_epsilon)
            {
                constraint_list.push(constraint_time);
            }
            material_constraint_map.forEach(constraint => {
                if(constraint.items.length > 0)
                    constraint_list.push(constraint);
            });            
        }

        var final_result = [];
        var final_objective_value = null;
        var final_comb = null;
        var filter_chefs = null;
        var my_chefs = null;
        var new_recipes = null;

        function recalc_price()
        {
            var e2 = document.getElementById("time_limit");
            var time_limit = e2.value*3600;

            g_debug_simplex_cnt = 0;

            var dateBegin = new Date();

            //const comb = comb_list[i];

            var objective_function = new Object();
            var constraint_list = []; 
            build_constraint(objective_function, constraint_list, new_recipes, filter_chefs, final_comb, time_limit);
            var modify_set = new Set();
            for (let i = 0; i < final_result.length; i++) {
                const pair = final_result[i];
//                if(pair[1] < g_epsilon)
//                    continue;
                if(pair[0].charAt(0) != "X")
                    continue;
                var e = document.getElementById("adjust"+pair[0].substr(1));
                if (e && e.value != "") {
                    var constraint = new Object();
                    constraint.opr_type = 0;
                    constraint.value = parseInt(e.value);
                    constraint.items = [[1, pair[0]]];
                    constraint_list.push(constraint);
                    modify_set.add(pair[0]);
                }
            }


            final_result = [];
            final_objective_value = new Object();
            var result = [];
            var objective_value = new Object();
            var r = solve_fast(objective_function, constraint_list, result, objective_value);
            if(r==1)
            {
                if(!("value" in final_objective_value) || (objective_value.value > final_objective_value.value))
                {
                    final_objective_value.value = objective_value.value;
                    final_result = result;
                }
            }
            var dateEnd = new Date();
            var dateDiff = dateEnd.getTime() - dateBegin.getTime();
            var e = document.getElementById("time");
            e.innerHTML = "time(ms):" + dateDiff;

            display_result(new_recipes, filter_chefs, modify_set);
        }

        function display_result(recipes, chefs, modify_set)
        {
            //var r = solve(objective_function, constraint_list, result, objective_value);
            var e2 = document.getElementById("price_add");
            var e = document.getElementById("price");
            if (("value" in final_objective_value)) {
                //var s = "复杂度:"+ g_debug_simplex_cnt + "<br>" + final_objective_value.value + "<br>";// + JSON.stringify(result) + "<br>";
                var s = "<table id=\"tb2\" border=\"1\">";
                    s += "<tr>";
                    s += "<td>";
                    s += "名称";
                    s += "</td>";
                    s += "<td>";
                    s += "菜谱";
                    s += "</td>";
                    s += "<td>";
                    s += "解";
                    s += "</td>";
                    s += "<td>";
                    s += "调整";
                    s += "</td>";
                    s += "<td>";
                    s += "材料";
                    s += "</td>";
                    s += "<td>";
                    s += "单价";
                    s += "</td>";
                    s += "<td>";
                    s += "数量";
                    s += "</td>";
                    s += "<td>";
                    s += "总价";
                    s += "</td>";
                    s += "<td>";
                    s += "时间(秒)";
                    s += "</td>";
                    s += "<td>";
                    s += "时间";
                    s += "</td>";
                    s += "</tr>";
                var total_time = 0;
                for (let i = 0; i < final_result.length; i++) {
                    const pair = final_result[i];
                    if(!(modify_set && modify_set.has(pair[0])) && pair[1] < g_epsilon)
                        continue;
                    if(pair[0].charAt(0) != "X")
                        continue;
                    var arr = pair[0].split("_");
                    var id = parseInt(arr[1]);
                    var recipe = get_recipe_by_id(recipes, id);
                    var index = parseInt(arr[2]);
                    var chef = chefs[index];
                    var price = calc_price(recipe, chef, chefs, e2.value);
                    total_time += recipe.total_time();
                    s += "<tr>";
                    s += "<td>";
                    s += chef.name;
                    s += "</td>";
                    s += "<td>";
                    s += recipe.name;
                    s += "</td>";
                    s += "<td>";
                    s += pair[1].toFixed(2);
                    s += "</td>";
                    s += "<td>";
                    if(modify_set && modify_set.has(pair[0]))
                        s += "<input type=\"number\" id=\"adjust_"+recipe.recipeId+"_"+index+"\" value=\""+ Math.round(pair[1]) +"\" />";
                    else if (Math.abs(pair[1] - 1) < g_epsilon) 
                        s += "<input type=\"number\" id=\"adjust_"+recipe.recipeId+"_"+index+"\" value=\"1\" />";
                    else
                        s += "<input type=\"number\" id=\"adjust_"+recipe.recipeId+"_"+index+"\"/>"
                    s += "</td>";
                    s += "<td>";
                    s += recipe.materials_name,
                    s += "</td>";
                    s += "<td>";
                    s += price;
                    s += "</td>";
                    s += "<td>";
                    s += recipe.limit;
                    s += "</td>";
                    s += "<td>";
                    s += price * recipe.limit;
                    s += "</td>";
                    s += "<td>";
                    s += recipe.total_time();
                    s += "</td>";
                    s += "<td>";
                    s += recipe.time_name();
                    s += "</td>";
                    s += "</tr>";
                }
                s += "</table>";
                s += "复杂度:"+ g_debug_simplex_cnt + " - " + final_objective_value.value + " - " + display_time(total_time);// + JSON.stringify(result) + "<br>";
                s += "<br><input type=\"button\" onclick=\"recalc_price()\" value=\"再试一次\">";
                e.innerHTML =  s;
                var x = new TableSorter("tb2");
            }
            else
            {
                e.innerHTML = "无解";
            }
        }
        
        function init()
        {
            do_ajax("get_db_data.php?name=bcjh_recipes&order_field=id", function(text){
                var my_recipes = JSON.parse(text);
                do_ajax("get_db_data.php?name=bcjh_chefs&order_field=id", function(text){
                    init_skills(g_bcjh_data.skills);
                    my_chefs = JSON.parse(text);
                    init_chefs(my_chefs);
                    new_recipes = build_recipes(g_bcjh_data.recipes, my_recipes, my_chefs);
                    display_chefs(my_chefs);
                });
            });
        }

        function display_price()
        {
            filter_chefs = filter_chef(my_chefs);

            var e2 = document.getElementById("time_limit");
            var time_limit = e2.value*3600;

            final_result = [];
            final_objective_value = new Object();
            g_debug_simplex_cnt = 0;

            var comb_list = combination(filter_chefs.length, 3);
            var dateBegin = new Date();
            for (let i = 0; i < comb_list.length; i++) {

                const comb = comb_list[i];

                var objective_function = new Object();
                var constraint_list = []; 
                build_constraint(objective_function, constraint_list, new_recipes, filter_chefs, comb, time_limit);

                var result = [];
                var objective_value = new Object();
                var r = solve_fast(objective_function, constraint_list, result, objective_value);
                if(r==1)
                {
                    if(!("value" in final_objective_value) || (objective_value.value > final_objective_value.value))
                    {
                        final_objective_value.value = objective_value.value;
                        final_result = result;
                        final_comb = comb;
                    }
                }
                //if (i == 0) {
                //    break;
                //}
            }
            var dateEnd = new Date();
            var dateDiff = dateEnd.getTime() - dateBegin.getTime();
            var e = document.getElementById("time");
            e.innerHTML = "time(ms):" + dateDiff;

            display_result(new_recipes, filter_chefs, null);
        }
        function calc() {
            for (let i = 0; i < my_maps.length; i++) {
                const map = my_maps[i];
                var e = document.getElementById("map"+i);
                var option = e.options[e.selectedIndex];
                map.value = parseInt(option.value);
            }
            display_price();
        }
        function display_materials()
        {
            var e = document.getElementById("materials");
            var s = "";
            for (let i = 0; i < g_bcjh_data.materials.length; i++) {
                const m = g_bcjh_data.materials[i];
                s += m.name;
                s += "<input type=\"number\" id=\"material_cnt_"+m.materialId+"\" style=\"width:50px;\"/>"
            }
            e.innerHTML = s;
        }
        function sort_chef(a,b)
        {
            return b.rarity - a.rarity;
        }      
        function display_chefs(chefs)
        {
            chefs.sort(sort_chef);
            if (chefs.length == 0)
                return;
            var e2 = document.getElementById("chefs");
            var rarity = chefs[0].rarity;
            var sChecked = "checked=\"checked\"";
            var s = "<input type=\"checkbox\" id=\"ck_all_chef_"+rarity+"\" onclick=\"select_chef("+rarity+")\" "+((rarity>1)?sChecked:"")+">全选 ";
            for (let i = 0; i < chefs.length; i++) {
                const chef = chefs[i];
                if(chef.rarity != rarity)
                {
                    s += "<br>" + "<input type=\"checkbox\" id=\"ck_all_chef_"+chef.rarity+"\" onclick=\"select_chef("+chef.rarity+")\" "+((chef.rarity>1)?sChecked:"")+">全选 ";
                    rarity = chef.rarity;
                }
                s += "<input type=\"checkbox\" id=\"ck_chef_"+chef.id+"\" "+((chef.rarity>1)?sChecked:"")+">" + chef.name;
            }
            e2.innerHTML = s;
        }     
        function select_chef(rarity)
        {
            var e = document.getElementById("ck_all_chef_"+rarity);
            for (let i = 0; i < my_chefs.length; i++) {
                const chef = my_chefs[i];
                if (chef.rarity == rarity)
                {
                    var e2 = document.getElementById("ck_chef_" + chef.id);
                    e2.checked = e.checked;
                }
            }
        }
        function filter_recipes_all()
        {

        }
        function filter_recipes_by_rarity(recipes)
        {
            var s = new Set();
            for (let i = 1; i <= 5; i++) {
                var e = document.getElementById("ck_rarity_"+i);
                if(e && e.checked)
                    s.add(i);
            }
            var arr = [];
            for (let i = 0; i < recipes.length; i++) {
                const recipe = recipes[i];
                if(s.has(recipe.rarity))
                    arr.push(recipe);
            }
            return arr;
        }
   
    </script>
</head>
<body>
    <a href="bcjh_recipes.html">返回</a><br>
    餐桌加成：<input type="number" id="price_add"/>%
    时间限制(h)：<input type="number" id="time_limit"/><input type="button" value="计算" onclick="display_price()"/><br>
    <!--稀有度：<input type="checkbox" id="ck_rarity_1" checked="checked">1火
    <input type="checkbox" id="ck_rarity_2" checked="checked">2火
    <input type="checkbox" id="ck_rarity_3" checked="checked">3火
    <input type="checkbox" id="ck_rarity_4" checked="checked">4火
    <input type="checkbox" id="ck_rarity_5" checked="checked">5火<br>
    稀有度：<input type="checkbox" id="ck_rarity_11" checked="checked">可
    <input type="checkbox" id="ck_rarity_21" checked="checked">优
    <input type="checkbox" id="ck_rarity_31" checked="checked">特
    <input type="checkbox" id="ck_rarity_41" checked="checked">神<br>    -->
    <div id="chefs"></div>
    <div id="materials"></div>
    <div id="price"></div>
    <div id="time"></div>
    <script type="text/javascript">
        //display_price();
        init();
        display_materials();
    </script>
    
</body>

</html>