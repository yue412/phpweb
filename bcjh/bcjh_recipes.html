<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>
        爆炒江湖
    </title>
    <style type="text/css">
        div.no {
            font-size: 120%;
            display: inline
        }

        div.yes {
            font-size: 80%;
            display: inline
        }

        div.content {
            color: #FF0000;
            display: inline
        }

        div.level {
            display: inline
        }
    </style>
    <script type="text/javascript" src="common.js">
    </script>
    <script type="text/javascript" src="bcjh_data.js">
    </script>
    <script type="text/javascript" src="bcjh_common.js">
    </script>
    <script type="text/javascript" src="bcjh_skill.js">
    </script>
    <script type="text/javascript" src="TableSorterV3.js">
    </script>
    <script type="text/javascript">
        function material_by_id(id)
        {
            var materials_dict = g_bcjh_data.materials;
            for (let i = 0; i < materials_dict.length; i++) {
                if (id == materials_dict[i].materialId)
                {
                    return materials_dict[i];
                }
            }
            return null;
        }
        function get_materials_name(materials)
        {
            var list = new Array();
            for (let i = 0; i < materials.length; i++) {
                const id = materials[i].material;
                const count = materials[i].quantity;
                var obj = material_by_id(id);
                list.push(obj.name + "*" + count);
            }
            return list.join(",");
        }
        function get_materials_max_time(materials, materials_map)
        {
            var list = new Array();
            var max_time = 0;
            for (let i = 0; i < materials.length; i++) {
                const id = materials[i].material;
                const count = materials[i].quantity;
                var obj = material_by_id(id);
                var time = materials_map.get(obj.name) * count;
                max_time = Math.max(max_time, time);
            }
            return max_time;
        }
        function display_time(time)
        {
            var hour = parseInt(time / 3600);
            time = time - hour*3600;
            var minute = parseInt(time / 60);
            var second = time - minute*60;
            var result = "";
            if(hour != 0)
                result += hour + "小时";
            if(minute != 0)
                result += minute + "分";
            if(second != 0)
                result += second + "秒";
            return result;
        }
        function calc_material_time()
        {
            var maps = g_bcjh_data.maps;
            var m = new Map();
            for (let i = 0; i < maps.length; i++) {
                var map = maps[i];
                var times = map.time;
                for (let j = 0; j < map.materials.length; j++) {
                    const material = map.materials[j];
                    var name = material.name;
                    var quantity = material.quantity;
                    var total_time = 0;
                    var n = 0;
                    for (let k = 0; k < quantity.length; k++) {
                        const pair = quantity[k];
                        if(pair[0] == 0)
                            continue;
                        var count = (pair[0] + pair[1])/2;
                        var time = times[k] / count;
                        total_time += time;
                        ++n;
                    }
                    m.set(name, total_time / n);
                }
            }
            return m;
        }
        function recipe_by_id(id)
        {
            var recipes = g_bcjh_data.recipes;
            for (let i = 0; i < recipes.length; i++) {
                const recipe = recipes[i];
                if(recipe.recipeId == id)
                {
                    return recipe;
                }
            }
            return null;
        }
        function clickCheckbox(id)
        {
            var recipe = recipe_by_id(id);
            var e1 = document.getElementById("price"+id);
            var e2 = document.getElementById("total_price"+id);
            var e3 = document.getElementById("price_"+id);
            var checked = document.getElementById("ck"+id).checked ? 1 : 0;
            var price = recipe.price;
            if (checked)
                price += recipe.exPrice;
            e1.innerHTML = price;
            e2.innerHTML = price*recipe.limit;
            e3.innerHTML = Math.round(price/recipe.time*3600);

            var url = "update_record.php?table_name=bcjh_recipes&primary_key=id&key_val=" + id +"&is_mastery="+checked;
            do_ajax(url, function (text) {
                // do nothing
                //var e = document.getElementById("test");
                //e.innerHTML = text;
            });            
        }
        var my_chefs = null;
        function changeRate(id)
        {
            var recipe = recipe_by_id(id);
            var e1 = document.getElementById("unlock"+id);
            var e2 = document.getElementById("chefs"+id);
            var val = document.getElementById("cb_rate"+id).value;
            var unlock = recipe.unlock;
            var recipe_chefs = get_recipe_chefs(recipe, my_chefs);
            if (val == 4)
                unlock = "-";
            e1.innerHTML = unlock;
            e2.innerHTML = display_recipe_chefs(recipe_chefs, val);

            var url = "update_record.php?table_name=bcjh_recipes&primary_key=id&key_val=" + id +"&rate="+val;
            do_ajax(url, function (text) {
                // do nothing
                //var e = document.getElementById("test");
                //e.innerHTML = text;
            });             
        }
        function display_recipes()
        {
            do_ajax("get_db_data.php?name=bcjh_recipes&order_field=id", function(text){
                var e = document.getElementById("recipes");
                var e2 = document.getElementById("recipes_count");
                var my_recipes = JSON.parse(text);
                init_skills(g_bcjh_data.skills);
                e2.innerHTML = "数量：" + my_recipes.length;
                do_ajax("get_db_data.php?name=bcjh_chefs&order_field=id", function(text){
                    // 菜谱
                    my_chefs = JSON.parse(text);
                    init_chefs(my_chefs);
                    var recipes = g_bcjh_data.recipes;
                    var materials = g_bcjh_data.materials;
                    var material_time_map = calc_material_time();
                    var new_recipes = build_recipes(recipes, my_recipes);
                    var s = "<table id=\"tb2\" border='1'>";
                    s += "<tr>";
                    s += "<td>";
                    s += "ID";
                    s += "</td>";
                    s += "<td>";
                    s += "名称";
                    s += "</td>";
                    s += "<td>";
                    s += "稀有度";
                    s += "</td>";
                    s += "<td>";
                    s += "材料";
                    s += "</td>";
                    s += "<td>";
                    s += "熟练";
                    s += "</td>";
                    s += "<td>";
                    s += "单价";
                    s += "</td>";
                    s += "<td>";
                    s += "总价";
                    s += "</td>";
                    s += "<td>";
                    s += "总时间(秒)";
                    s += "</td>";
                    s += "<td>";
                    s += "总时间";
                    s += "</td>";
                    s += "<td>";
                    s += "金币/小时";
                    s += "</td>";
                    s += "<td>";
                    s += "评级";
                    s += "</td>";
                    s += "<td>";
                    s += "解锁";
                    s += "</td>";
                    s += "<td>";
                    s += "效率";
                    s += "</td>";
                    s += "<td>";
                    s += "推荐厨师";
                    s += "</td>";
                    s += "</tr>";
                    for (let j = 0; j < new_recipes.length; j++) {
                        const recipe = new_recipes[j];
                        //var is_mastery = parseInt(my_recipes[j].is_mastery) != 0
                        //var calc_price = is_mastery ? recipe.price + recipe.exPrice : recipe.price;
                        var total_time = recipe.limit * recipe.time;
                        var check_val = recipe.is_mastery ? "checked=\"checked\"" : "";
                        //var rate = parseInt(my_recipes[j].rate);
                        var material_time = get_materials_max_time(recipe.materials, material_time_map)
                        var recipe_chefs = get_recipe_chefs(recipe, my_chefs);
                        //var checkbox_id = "ck_" + recipe.galleryId;
                        s += "<tr>";
                        s += "<td>";
                        s += recipe.galleryId;
                        s += "</td>";
                        s += "<td>";
                        s += recipe.name;
                        s += "</td>";
                        s += "<td>";
                        s += recipe.rarity;
                        s += "</td>";
                        s += "<td>";
                        s += get_materials_name(recipe.materials);
                        s += "</td>";
                        s += "<td>";
                        s += "<input type=\"checkbox\" id=\"ck"+recipe.recipeId+"\" onclick=\"clickCheckbox("+recipe.recipeId+")\" "+check_val+">";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"price" + recipe.recipeId + "\">";
                        s += recipe.calc_price();
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"total_price" + recipe.recipeId + "\">";
                        s += recipe.limit * recipe.calc_price();
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += total_time;
                        s += "</td>";
                        s += "<td>";
                        s += display_time(total_time);
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"price_" + recipe.recipeId + "\">";
                        s += Math.round(recipe.calc_price()/recipe.time*3600);
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += "<select id=\"cb_rate"+recipe.recipeId+"\" onchange=\"changeRate("+recipe.recipeId+")\">";
                        for (let i = 0; i < g_Rate_names.length; i++) {
                            const name = g_Rate_names[i];
                            var flag = i == recipe.rate ? "selected = \"selected\"" : "";
                            s += "<option value=\""+i+"\" "+flag+">"+name+"</option>";
                        }
                        s += "</select>";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"unlock" + recipe.recipeId + "\">";
                        s += recipe.rate == 4 ? "-" : recipe.unlock;
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += (recipe.calc_price() / (recipe.time + material_time) / 0.02).toFixed(2);
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"chefs" + recipe.recipeId + "\">";
                        s += display_recipe_chefs(recipe_chefs, recipe.rate);
                        s += "</div>";
                        s += "</td>";
                        s += "</tr>";
                    }
                    s += "</table>";
                    e.innerHTML = s;
                    var x = new TableSorter("tb2");
                });
            });
        }
    </script>
</head>
<body>
    <a href="bcjh_chefs.html">厨师</a>
    <a href="bcjh_price.html">菜价</a><br>
    <a href="bcjh_new_recipe.html">添加菜谱</a>
    <div id="recipes_count"></div>
    <div id="recipes"></div>
    <script type="text/javascript">
        display_recipes();
    </script>
    <div id="test"></div>
</body>

</html>