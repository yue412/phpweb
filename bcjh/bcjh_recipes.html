<html>

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>
        爆炒江湖
    </title>
    <style type="text/css">
        div.no {
            font-size: 120%;
            display: inline
        }

        div.yes {
            font-size: 80%;
            display: inline
        }

        div.content {
            color: #FF0000;
            display: inline
        }

        div.level {
            display: inline
        }
    </style>
    <script type="text/javascript" src="common.js">
    </script>
    <script type="text/javascript" src="bcjh_data.js">
    </script>
    <script type="text/javascript" src="TableSorterV3.js">
    </script>
    <script type="text/javascript">
        function sort_recipe(a,b)
        {
            return a.recipeId - b.recipeId;
        }
        function material_by_id(id)
        {
            var materials_dict = g_bcjh_data.materials;
            for (let i = 0; i < materials_dict.length; i++) {
                if (id == materials_dict[i].materialId)
                {
                    return materials_dict[i];
                }
            }
            return null;
        }
        function get_materials_name(materials)
        {
            var list = new Array();
            for (let i = 0; i < materials.length; i++) {
                const id = materials[i].material;
                const count = materials[i].quantity;
                var obj = material_by_id(id);
                list.push(obj.name + "*" + count);
            }
            return list.join(",");
        }
        function get_materials_max_time(materials, materials_map)
        {
            var list = new Array();
            var max_time = 0;
            for (let i = 0; i < materials.length; i++) {
                const id = materials[i].material;
                const count = materials[i].quantity;
                var obj = material_by_id(id);
                var time = materials_map.get(obj.name) * count;
                max_time = Math.max(max_time, time);
            }
            return max_time;
        }
        function display_time(time)
        {
            var hour = parseInt(time / 3600);
            time = time - hour*3600;
            var minute = parseInt(time / 60);
            var second = time - minute*60;
            var result = "";
            if(hour != 0)
                result += hour + "小时";
            if(minute != 0)
                result += minute + "分";
            if(second != 0)
                result += second + "秒";
            return result;
        }
        function calc_material_time()
        {
            var maps = g_bcjh_data.maps;
            var m = new Map();
            for (let i = 0; i < maps.length; i++) {
                var map = maps[i];
                var times = map.time;
                for (let j = 0; j < map.materials.length; j++) {
                    const material = map.materials[j];
                    var name = material.name;
                    var quantity = material.quantity;
                    var total_time = 0;
                    var n = 0;
                    for (let k = 0; k < quantity.length; k++) {
                        const pair = quantity[k];
                        if(pair[0] == 0)
                            continue;
                        var count = (pair[0] + pair[1])/2;
                        var time = times[k] / count;
                        total_time += time;
                        ++n;
                    }
                    m.set(name, total_time / n);
                }
            }
            return m;
        }
        function recipe_by_id(id)
        {
            var recipes = g_bcjh_data.recipes;
            for (let i = 0; i < recipes.length; i++) {
                const recipe = recipes[i];
                if(recipe.recipeId == id)
                {
                    return recipe;
                }
            }
            return null;
        }
        function clickCheckbox(id)
        {
            var recipe = recipe_by_id(id);
            var e1 = document.getElementById("price"+id);
            var e2 = document.getElementById("total_price"+id);
            var checked = document.getElementById("ck"+id).checked ? 1 : 0;
            var price = recipe.price;
            if (checked)
                price += recipe.exPrice;
            e1.innerHTML = price;
            e2.innerHTML = price*recipe.limit;

            var url = "update_record.php?table_name=bcjh_recipes&primary_key=id&key_val=" + id +"&is_mastery="+checked;
            do_ajax(url, function (text) {
                // do nothing
                //var e = document.getElementById("test");
                //e.innerHTML = text;
            });            
        }
        function changeRate(id)
        {
            var recipe = recipe_by_id(id);
            var e1 = document.getElementById("unlock"+id);
            var val = document.getElementById("cb_rate"+id).value;
            var unlock = recipe.unlock;
            if (val == 4)
                unlock = "-";
            e1.innerHTML = unlock;

            var url = "update_record.php?table_name=bcjh_recipes&primary_key=id&key_val=" + id +"&rate="+val;
            do_ajax(url, function (text) {
                // do nothing
                //var e = document.getElementById("test");
                //e.innerHTML = text;
            });             
        }
        function display_recipes()
        {
            do_ajax("get_db_data.php?name=bcjh_recipes&order_field=id", function(text){
                var e = document.getElementById("recipes");
                var my_recipes = JSON.parse(text);
                // 菜谱
                var recipes = g_bcjh_data.recipes;
                var materials = g_bcjh_data.materials;
                var material_time_map = calc_material_time();
                var arrRate = ["", "可", "优", "特", "神"]; 
                recipes.sort(sort_recipe);
                var s = "<table id=\"tb2\" border='1'>";
                s += "<tr>";
                s += "<td>";
                s += "ID";
                s += "</td>";
                s += "<td>";
                s += "名称";
                s += "</td>";
                s += "<td>";
                s += "稀有度";
                s += "</td>";
                s += "<td>";
                s += "材料";
                s += "</td>";
                s += "<td>";
                s += "熟练";
                s += "</td>";
                s += "<td>";
                s += "单价";
                s += "</td>";
                s += "<td>";
                s += "总价";
                s += "</td>";
                s += "<td>";
                s += "总时间(秒)";
                s += "</td>";
                s += "<td>";
                s += "总时间";
                s += "</td>";
                s += "<td>";
                s += "评级";
                s += "</td>";
                s += "<td>";
                s += "解锁";
                s += "</td>";
                s += "<td>";
                s += "效率";
                s += "</td>";
                s += "</tr>";
                var i = 0;
                var j = 0;
                while (i < recipes.length && j < my_recipes.length) {
                    var my_id = parseInt(my_recipes[j].id);
                    if (recipes[i].recipeId > my_id)
                        ++j;
                    else if (recipes[i].recipeId < my_id)
                        ++i;
                    else {
                        var is_mastery = parseInt(my_recipes[j].is_mastery) != 0
                        var calc_price = is_mastery ? recipes[i].price + recipes[i].exPrice : recipes[i].price;
                        var total_time = recipes[i].limit * recipes[i].time;
                        var check_val = is_mastery ? "checked=\"checked\"" : "";
                        var rate = parseInt(my_recipes[j].rate);
                        //var checkbox_id = "ck_" + recipes[i].galleryId;
                        s += "<tr>";
                        s += "<td>";
                        s += recipes[i].galleryId;
                        s += "</td>";
                        s += "<td>";
                        s += recipes[i].name;
                        s += "</td>";
                        s += "<td>";
                        s += recipes[i].rarity;
                        s += "</td>";
                        s += "<td>";
                        s += get_materials_name(recipes[i].materials);
                        s += "</td>";
                        s += "<td>";
                        s += "<input type=\"checkbox\" id=\"ck"+recipes[i].recipeId+"\" onclick=\"clickCheckbox("+recipes[i].recipeId+")\" "+check_val+">";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"price" + recipes[i].recipeId + "\">";
                        s += calc_price;
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"total_price" + recipes[i].recipeId + "\">";
                        s += recipes[i].limit * calc_price;
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += total_time;
                        s += "</td>";
                        s += "<td>";
                        s += display_time(total_time);
                        s += "</td>";
                        s += "<td>";
                        s += "<select id=\"cb_rate"+recipes[i].recipeId+"\" onchange=\"changeRate("+recipes[i].recipeId+")\">";
                        for (let i = 0; i < arrRate.length; i++) {
                            const name = arrRate[i];
                            var flag = i == rate ? "selected = \"selected\"" : "";
                            s += "<option value=\""+i+"\" "+flag+">"+name+"</option>";
                        }
                        s += "</select>";
                        s += "</td>";
                        s += "<td>";
                        s += "<div id=\"unlock" + recipes[i].recipeId + "\">";
                        s += rate == 4 ? "-" : recipes[i].unlock;
                        s += "</div>";
                        s += "</td>";
                        s += "<td>";
                        s += (calc_price / (recipes[i].time + get_materials_max_time(recipes[i].materials, material_time_map)) / 0.02).toFixed(2);
                        s += "</td>";
                        s += "</tr>";
                        ++i;
                        ++j;
                    }
                }
                s += "</table>";
                e.innerHTML = s;
                var x = new TableSorter("tb2");
            });
        }
    </script>
</head>
<body>
    <a href="bcjh_chefs.html">厨师</a>
    <div id="recipes"></div>
    <script type="text/javascript">
        display_recipes();
    </script>
    <div id="test"></div>
</body>

</html>